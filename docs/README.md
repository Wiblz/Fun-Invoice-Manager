# File upload
I had to take some time to consider how file uploading should be implemented.
The first thought was to use a trivial approach, such as uploading the file to the server and storing it in a directory. However, upon reading the minio docs as well as finding out that "valet key" pattern is a goto approach for file uploading, I decided to go with the latter.

The valet key pattern is a pattern where the client is given a temporary URL to upload the file to. This URL is generated by the server and is only valid for a short period of time. This way, the server does not have to handle the file upload itself, and the client can upload the file directly to the storage, saving ingress and egress bandwidth.
After that I came to realization, that in order to use file hash as a filename, it (obviously) has to be calculated before the file is uploaded.
1. The client could calculate the hash and send it to the server, which would then generate the valet key and return it to the client. This introduces a problem: the client can never be trusted. The client could easily forge any file metadata, including the hash.
The possible solutions include using a temp environment for file uploads, then getting a file on backend and then perform any necessary validation. This obviously negates the benefits of the valet key pattern and is pointless.
2. The client just uploads the file to the server, and the server calculates the hash and generates the valet key. This is, essentially the trivial approach I was considering at the beginning.
However, the server doesn't have to store the file. After initial validation/processing is finished it can be removed from the server. A presigned URL can then be used by client to retrieve the file from the storage.

Eventually, I ended up going with the second approach. I don't see any other way to use a hash as a filename and avoiding trusting the client at the same time.
Considering that additional file processing is expected (extracting metadata, raw text, perhaps extracting some data with OCR or LLM), there's no avoiding uploading the file to our backend.
I am still using self-hosted minio server for file storage, and a minio client for file uploads. This makes it easy to switch to an actual S3 in production if needed.
